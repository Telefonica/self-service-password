<?php
#==============================================================================
# LTB Self Service Password
#
# Copyright (C) 2009 Clement OUDOT
# Copyright (C) 2009 LTB-project.org
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# GPL License: http://www.gnu.org/licenses/gpl.txt
#
#==============================================================================

# This page is called to change password

#==============================================================================
# POST parameters
#==============================================================================
# Initiate vars
$result = "";
$login = "";
$confirmpassword = "";
$newpassword = "";
$oldpassword = "";
$ldap = "";
$userdn = "";
if (!isset($pwd_forbidden_chars)) { $pwd_forbidden_chars=""; }
$mail = "";

if (isset($_POST["confirmpassword"]) and $_POST["confirmpassword"]) { $confirmpassword = strval($_POST["confirmpassword"]); }
 else { $result = "confirmpasswordrequired"; }
if (isset($_POST["newpassword"]) and $_POST["newpassword"]) { $newpassword = strval($_POST["newpassword"]); }
 else { $result = "newpasswordrequired"; }
if (isset($_POST["oldpassword"]) and $_POST["oldpassword"]) { $oldpassword = strval($_POST["oldpassword"]); }
 else { $result = "oldpasswordrequired"; }
if (isset($_REQUEST["login"]) and $_REQUEST["login"]) { $login = strval($_REQUEST["login"]); }
 else { $result = "loginrequired"; }
if (! isset($_REQUEST["login"]) and ! isset($_POST["confirmpassword"]) and ! isset($_POST["newpassword"]) and ! isset($_POST["oldpassword"]))
 { $result = "emptychangeform"; }

# Check the entered username for characters that our installation doesn't support
if ( $result === "" ) {
    $result = check_username_validity($login,$login_forbidden_chars);
}

# Match new and confirm password
if ( $newpassword != $confirmpassword ) { $result="nomatch"; }

#==============================================================================
# Check reCAPTCHA
#==============================================================================
if ( $result === "" && $use_recaptcha ) {
    $result = check_recaptcha($recaptcha_privatekey, $recaptcha_request_method, $_POST['g-recaptcha-response'], $login);
}

#==============================================================================
# Check old password
#==============================================================================
if ( $result === "" ) {

    # Connect to LDAP
    $ldap = ldap_connect($ldap_url);
    ldap_set_option($ldap, LDAP_OPT_PROTOCOL_VERSION, 3);
    ldap_set_option($ldap, LDAP_OPT_REFERRALS, 0);
    if ( $ldap_starttls && !ldap_start_tls($ldap) ) {
        $result = "ldaperror";
        error_log("LDAP - Unable to use StartTLS");
    } else {

    # Bind
    if ( isset($ldap_binddn) && isset($ldap_bindpw) ) {
        $bind = ldap_bind($ldap, $ldap_binddn, $ldap_bindpw);
    } else {
        $bind = ldap_bind($ldap);
    }

    if ( !$bind ) {
        $result = "ldaperror";
        $errno = ldap_errno($ldap);
        if ( $errno ) {
	    error_log("LDAP - Bind error $errno  (".ldap_error($ldap).")");
        }
    } else {

    # Search for user
    $ldap_filter = str_replace("{login}", $login, $ldap_filter);
    $search = ldap_search($ldap, $ldap_base, $ldap_filter);

    $errno = ldap_errno($ldap);
    if ( $errno ) {
        $result = "ldaperror";
        error_log("LDAP - Search error $errno  (".ldap_error($ldap).")");
    } else {

    # Get user DN
    $entry = ldap_first_entry($ldap, $search);
    $userdn = ldap_get_dn($ldap, $entry);

    if( !$userdn ) {
        $result = "badcredentials";
        error_log("LDAP - User $login not found");
    } else {

    # Get user email for notification
    if ( $notify_on_change ) {
        $mailValues = ldap_get_values($ldap, $entry, $mail_attribute);
        if ( $mailValues["count"] > 0 ) {
            $mail = $mailValues[0];
        }
    }

    # Check objectClass to allow samba and shadow updates
    $ocValues = ldap_get_values($ldap, $entry, 'objectClass');
    if ( !in_array( 'sambaSamAccount', $ocValues ) and !in_array( 'sambaSAMAccount', $ocValues ) ) {
        $samba_mode = false;
    }
    if ( !in_array( 'shadowAccount', $ocValues ) ) {
        $shadow_options['update_shadowLastChange'] = false;
        $shadow_options['update_shadowExpire'] = false;
    }

    # Bind with old password
    $bind = ldap_bind($ldap, $userdn, $oldpassword);
    if ( !$bind ) {
        $result = "badcredentials";
        $errno = ldap_errno($ldap);
        if ( $errno ) {
            error_log("LDAP - Bind user error $errno  (".ldap_error($ldap).")");
        }
        if ( ($errno == 49) && $ad_mode ) {
            if ( ldap_get_option($ldap, 0x0032, $extended_error) ) {
                error_log("LDAP - Bind user extended_error $extended_error  (".ldap_error($ldap).")");
                $extended_error = explode(', ', $extended_error);
                if ( strpos($extended_error[2], '773') or strpos($extended_error[0], 'NT_STATUS_PASSWORD_MUST_CHANGE') ) {
                    error_log("LDAP - Bind user password needs to be changed");
                    $result = "";
                }
                if ( ( strpos($extended_error[2], '532') or strpos($extended_error[0], 'NT_STATUS_ACCOUNT_EXPIRED') ) and $ad_options['change_expired_password'] ) {
                    error_log("LDAP - Bind user password is expired");
                    $result = "";
                }
                unset($extended_error);
            }
        }
    }
    if ( $result === "" )  {

        # Rebind as Manager if needed
        if ( $who_change_password == "manager" ) {
            $bind = ldap_bind($ldap, $ldap_binddn, $ldap_bindpw);
        }

    }}}}}

}

#==============================================================================
# Check password strength
#==============================================================================
if ( $result === "" ) {
    $result = check_password_strength( $newpassword, $oldpassword, $pwd_policy_config, $login );
}

#==============================================================================
# Change password
#==============================================================================
if ( $result === "" ) {
    $result = change_password($ldap, $userdn, $newpassword, $ad_mode, $ad_options, $samba_mode, $samba_options, $shadow_options, $hash, $hash_options, $who_change_password, $oldpassword);
    if ( $result === "passwordchanged" && isset($posthook) ) {
        $command = escapeshellcmd($posthook).' '.escapeshellarg($login).' '.escapeshellarg($newpassword).' '.escapeshellarg($oldpassword);
        exec($command, $posthook_output, $posthook_return);
    }
}

#==============================================================================
# HTML
#==============================================================================
if ( in_array($result, array($obscure_failure_messages)) ) { $result = "badcredentials"; }
?>

<?php   if ($result == "badcredentials" or $result == "minspecial" or $result == "mindigit" or $result == "minspecial") {
            include("errorpage.php");
        }
        elseif ( $result !== "passwordchanged" ) { ?>

<?php
if ($pwd_show_policy_pos === 'above') {
    show_policy($messages, $pwd_policy_config, $result);
}
?>

<!doctype html>
<html>

<head>
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Smart STEPS</title>
  <link href="../css/site-bf872215389ce9bdfed0fb044f437dc9-801413a6.css" rel="stylesheet" />
  <link href="../images/favicon-32x32-e02d4900.png" rel="icon" type="image/png" />
</head>

<body class="index">
  <div class="main">
    <div class="modal-form">
      <div class="modal-form__container">
        <div class="header">
          <h1 class="bx--type-h1"> Smart STEPS </h1>
          <h2 class="bx--type-h3"> <?php echo $messages['title']; ?> </h2>
        </div>
        <form id="main" class="form-horizontal" action="#" method="post" novalidate>
          <div class="form-group col-xs">
            <label class="form-group__label" for="login"><?php echo $messages['username']; ?></label>
            <input id="login" class="form-group__input input-user" placeholder="<?php echo $messages['username']; ?>" name="login">
          </div>
          <div class="form-group col-xs">
            <label class="form-group__label" for="oldpassword"><?php echo $messages['oldpassword']; ?></label>
            <input id="oldpassword" class="form-group__input input-pass" type="password" placeholder="<?php echo $messages['oldpassword']; ?>" name="oldpassword">
          </div>
          <div class="form-group col-xs">
            <label class="form-group__label" for="newpassword"><?php echo $messages['newpassword']; ?></label>
            <input id="newpassword" class="form-group__input input-pass" type="password" placeholder="<?php echo $messages['newpassword']; ?>" name="newpassword">
          </div>
          <div class="form-group col-xs">
            <label class="form-group__label" for="confirmpassword"><?php echo $messages['confirmpassword']; ?></label>
            <input id="confirmpassword" class="form-group__input input-pass" type="password" placeholder="<?php echo $messages['confirmpassword']; ?>"
              name="confirmpassword">
            </div>
          <div class="form-group">
            <button type="submit" class="c-btn btn-primary btn-medium">
              <?php echo $messages['submit']; ?>
            </button>
            <p class="p--type-p u-text-center form-group-p"><?php echo $messages['changehelpreset']; ?>
              <a href="index.php?action=sendtoken" title="Resetear con mi e-mail" class="reset-password"><?php echo $messages['emptysendtokenform']; ?></a>
            </p>
          </div>
        </form>
        <footer class="footer">
          <div class="content">
            <a href="https://luca-d3.com/" target="_blank" alt="LUCA Logo">
              <?xml version="1.0" encoding="UTF-8"?><svg width="71px" height="18px" viewBox="0 0 71 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <title>Shape</title>
                <desc>Created with Sketch.</desc>
                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                  <g id="Desktop-1280x900-Copy-5" transform="translate(-372.000000, -791.000000)" fill="#1D1D1B" fill-rule="nonzero">
                    <g id="logo-endoso" transform="translate(372.000000, 791.000000)">
                      <g id="Shape">
                        <path d="M4.54479623,17.9901586 C4.07006206,17.9948821 3.61277641,17.8179112 3.27330135,17.4980864 L0.510736175,14.8359759 C0.178842756,14.5088452 -0.00480610002,14.0681877 9.56622738e-05,13.6107162 L9.56622738e-05,0.492072171 C9.56622738e-05,0.220308215 0.228717207,4.99222288e-17 0.510736175,0 L4.18734787,0 C4.46936683,1.66407429e-17 4.69798838,0.220308215 4.69798838,0.492072171 L4.69798838,13.0251504 C4.68566897,13.1877169 4.7473371,13.3474081 4.86694439,13.4626661 C4.98655168,13.5779241 5.15226877,13.6373498 5.3209698,13.6254784 L11.9950413,13.6254784 C12.2770603,13.6254784 12.5056818,13.8457866 12.5056818,14.1175506 L12.5056818,17.5079278 C12.5056818,17.7796918 12.2770603,18 11.9950413,18 L4.54479623,17.9901586 Z"></path>
                        <path d="M27.8485909,17.9999078 C28.3128077,18.0046338 28.7599625,17.8275671 29.0919167,17.5075689 L31.7733061,14.858786 C32.0978467,14.5314779 32.2774269,14.0905817 32.2726337,13.6328623 L32.2726337,0.492338834 C32.2726337,0.220427604 32.0490771,1.66497609e-17 31.7733061,0 L28.1781471,0 C27.9023761,-1.66497609e-17 27.6788195,0.220427604 27.6788195,0.492338834 L27.6788195,13.0322089 C27.690866,13.1948636 27.6305641,13.3546413 27.5136066,13.4699618 C27.3966491,13.5852823 27.2346034,13.6447402 27.0696398,13.6328623 L22.1662424,13.6328623 C21.997983,13.6509122 21.8303036,13.5941985 21.7087097,13.4781126 C21.5871157,13.3620266 21.5242193,13.1986091 21.5370896,13.0322089 L21.5370896,0.492338834 C21.5370896,0.220427604 21.313533,1.66497609e-17 21.037762,0 L17.442603,0 C17.166832,-1.66497609e-17 16.9432754,0.220427604 16.9432754,0.492338834 L16.9432754,13.6180921 C16.9384822,14.0758115 17.1180624,14.5167078 17.442603,14.8440158 L20.1239924,17.4927988 C20.4559466,17.8127969 20.9031014,17.9898637 21.3673182,17.9851376 L27.8485909,17.9999078 Z"></path>
                        <path d="M37.1137313,13.6342257 C37.1088682,14.0923186 37.2910675,14.5335747 37.6203414,14.8611498 L40.3459037,17.5071671 C40.6826993,17.8274264 41.1363756,18.0046376 41.6073628,17.9999077 L50.7263445,17.9999077 C51.0061375,17.9999077 51.2329545,17.7793002 51.2329545,17.5071671 L51.2329545,14.1318937 C51.2329545,13.8597606 51.0061375,13.6391531 50.7263445,13.6391531 L42.3824762,13.6391531 C42.2118827,13.6585925 42.0412447,13.6031706 41.9168898,13.4879344 C41.7925349,13.3726982 41.7273679,13.209606 41.7390814,13.0429369 L41.7390814,4.99155494 C41.7268592,4.82876751 41.7880406,4.66885943 41.9067039,4.55344483 C42.0253671,4.43803023 42.1897762,4.3785238 42.3571457,4.39041136 L50.7263445,4.39041136 C51.0061375,4.39041136 51.2329545,4.16980387 51.2329545,3.89767073 L51.2329545,0.492832944 C51.2329545,0.220699805 51.0061375,9.23089506e-05 50.7263445,9.23089506e-05 L41.6073628,9.23089506e-05 C41.1363756,-0.00463762807 40.6826993,0.172573642 40.3459037,0.492832944 L37.6406058,3.15855978 C37.3113319,3.48613495 37.1291326,3.92739102 37.1339957,4.38548396 L37.1137313,13.6342257 Z"></path>
                        <path d="M70.4559068,3.14637761 L67.7753742,0.493240539 C67.443526,0.172716369 66.9965141,-0.0046414636 66.5324456,9.23852944e-05 L60.0931773,9.23852944e-05 C59.6291089,-0.0046414636 59.1820969,0.172716369 58.8502488,0.493240539 L56.1697161,3.14637761 C55.8452793,3.4742237 55.6657564,3.9158447 55.6705481,4.37431651 L55.6705481,17.5068518 C55.6705481,17.7792101 55.8940332,18 56.1697161,18 L59.7637264,18 C60.0394093,18 60.2628945,17.7792101 60.2628945,17.5068518 L60.2628945,12.3386592 C60.2508518,12.1757371 60.3111345,12.0156968 60.4280546,11.9001867 C60.5449747,11.7846767 60.7069686,11.725121 60.8718795,11.7370184 L65.7986685,11.7370184 C65.9635794,11.725121 66.1255734,11.7846767 66.2424935,11.9001867 C66.3594136,12.0156968 66.4196962,12.1757371 66.4076536,12.3386592 L66.4076536,17.5068518 C66.4076536,17.7792101 66.6311388,18 66.9068217,18 L70.5008319,18 C70.7765148,18 71,17.7792101 71,17.5068518 L71,4.37431651 C70.9929262,3.90942274 70.7968406,3.46688634 70.4559068,3.14637761 Z M66.3876869,7.91512025 C66.3997295,8.07804231 66.3394469,8.23808265 66.2225268,8.3535927 C66.1056067,8.46910275 65.9436127,8.5286584 65.7787018,8.516761 L60.8519128,8.516761 C60.6870019,8.5286584 60.525008,8.46910275 60.4080879,8.3535927 C60.2911678,8.23808265 60.2308851,8.07804231 60.2429277,7.91512025 L60.2429277,4.95623133 C60.2308851,4.79330927 60.2911678,4.63326894 60.4080879,4.51775889 C60.525008,4.40224883 60.6870019,4.34269319 60.8519128,4.35459058 L65.7787018,4.35459058 C65.9436127,4.34269319 66.1056067,4.40224883 66.2225268,4.51775889 C66.3394469,4.63326894 66.3997295,4.79330927 66.3876869,4.95623133 L66.3876869,7.91512025 Z"></path>
                      </g>
                    </g>
                  </g>
                </g>
              </svg></a><a href="https://www.telefonica.com/es/home" target="_blank" alt="TelefÃ³nica Logo">
              <?xml version="1.0" encoding="UTF-8"?><svg width="124px" height="18px" viewBox="0 0 124 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <title>telefonica data unit logo</title>
                <desc>Created with Sketch.</desc>
                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                  <g id="Desktop-1280x900-Copy-5" transform="translate(-784.000000, -791.000000)" fill="#999999">
                    <g id="logo-endoso" transform="translate(372.000000, 791.000000)">
                      <path d="M531.649133,5.17122232 L529.318875,5.17122232 L529.538843,3.93141374 L536,3.93141374 L535.639521,5.17122232 L533.36944,5.17122232 L532.269308,11.4493957 L530.548709,11.4493957 L531.649133,5.17122232 Z M526.588409,3.93141374 L528.308424,3.93141374 L526.988325,11.4493957 L525.277949,11.4493957 L526.588409,3.93141374 Z M518.416293,3.93141374 L519.656351,3.93141374 L522.377177,8.85035283 L523.247116,3.93141374 L524.757096,3.93141374 L523.427064,11.4493957 L522.076875,11.4493957 L519.426451,6.77047611 L518.606464,11.4493957 L517.096193,11.4493957 L518.416293,3.93141374 Z M510.434348,10.959137 C509.893922,10.4995377 509.69411,9.90941682 509.69411,9.11986374 C509.69411,8.77005434 509.734131,8.41002514 509.824105,7.91042258 L510.534254,3.93141374 L512.214832,3.93141374 L511.434574,8.35016627 C511.364465,8.77005434 511.35424,8.97970638 511.35424,9.09971612 C511.35424,9.3598832 511.404485,9.66034553 511.584141,9.89014519 C511.794469,10.1593641 512.144431,10.2898856 512.614747,10.2898856 C513.214766,10.2898856 513.584885,10.0802336 513.804853,9.82999432 C514.044685,9.55960743 514.204768,9.16979479 514.334763,8.4599562 L515.134885,3.93141374 L516.674953,3.93141374 L515.784857,8.97036256 C515.615134,9.92956444 515.245307,10.5196853 514.774991,10.9094979 C514.164747,11.4199043 513.404938,11.5988969 512.544638,11.5988969 C511.64461,11.5988969 510.954325,11.3997567 510.434348,10.959137 L510.434348,10.959137 Z M503.552243,8.32038284 L503.182416,5.70119231 L503.16226,5.70119231 L501.921909,8.32038284 L503.552243,8.32038284 Z M502.522512,3.93141374 L504.412835,3.93141374 L505.812684,11.4493957 L504.052356,11.4493957 L503.752346,9.55960743 L501.311958,9.55960743 L500.401706,11.4493957 L498.681983,11.4493957 L502.522512,3.93141374 Z M495.721325,5.17122232 L493.390775,5.17122232 L493.61045,3.93141374 L500.071608,3.93141374 L499.711421,5.17122232 L497.441048,5.17122232 L496.340916,11.4493957 L494.620609,11.4493957 L495.721325,5.17122232 Z M490.069054,8.32038284 L489.699227,5.70119231 L489.679071,5.70119231 L488.43872,8.32038284 L490.069054,8.32038284 Z M489.039323,3.93141374 L490.929354,3.93141374 L492.329203,11.4493957 L490.569167,11.4493957 L490.269158,9.55960743 L487.828769,9.55960743 L486.918517,11.4493957 L485.198502,11.4493957 L489.039323,3.93141374 Z M480.887071,10.1993673 C481.817188,10.1993673 482.437363,9.96927569 482.91732,9.26965691 C483.317235,8.69997567 483.607312,7.8301241 483.607312,6.90041366 C483.607312,6.32080461 483.497475,5.92077216 483.24771,5.63111363 C482.987429,5.3309433 482.567066,5.18144213 481.887005,5.18144213 L481.187081,5.18144213 L480.316557,10.1993673 L480.887071,10.1993673 Z M479.696966,3.93141374 L481.927026,3.93141374 C483.047606,3.93141374 484.097493,4.12150215 484.727601,4.78170168 C485.217782,5.30145186 485.387797,6.01129045 485.387797,6.87092222 C485.387797,8.2006651 484.977365,9.47989294 484.147738,10.3295969 C483.317235,11.169373 482.227328,11.4493957 480.706832,11.4493957 L478.376574,11.4493957 L479.696966,3.93141374 Z M438.528779,4.57146565 C438.770656,4.57146565 438.869393,4.74082245 438.869393,4.95076649 C438.860629,5.95464352 437.63284,7.23737529 436.038145,8.17263363 C436.44069,6.62155893 437.554259,4.55920188 438.528779,4.57146565 L438.528779,4.57146565 Z M433.876734,9.79232703 C433.865341,10.8280315 434.415115,11.6958391 435.814964,11.646492 C437.317056,11.6041528 438.68594,10.7360532 439.868159,9.49390867 C439.570194,10.2933896 439.316924,10.9778246 439.162392,11.3483656 C438.72304,12.442177 438.401413,13.3315922 437.725735,13.8449185 L437.798766,13.977192 C439.781106,14.0916538 440.521636,12.7017601 441.336072,10.4326709 C442.151385,8.16212183 442.840793,6.18590316 443.379175,4.81674102 C444.245025,4.81674102 445.474274,4.84681645 446.161054,4.69147538 C444.366839,5.48716035 442.840793,8.3489983 443.01928,10.2349907 C443.101074,11.0730148 443.59885,11.646492 444.662467,11.646492 C446.72222,11.646492 448.45392,9.21009003 449.116745,7.60266039 C449.495335,6.68170979 449.747729,5.89653662 449.785705,5.10610755 C450.277346,5.01967718 450.746787,4.93499878 450.980776,4.89966745 C451.431521,4.83951659 451.344176,5.33707519 451.202205,5.71287209 C450.360017,8.06488766 448.901451,11.4788872 448.895025,11.5302782 L450.504033,11.5302782 C451.202205,10.0816936 451.634546,9.15169113 452.188117,8.16708573 C452.857953,7.0043637 454.355663,5.09209182 454.950424,5.08829589 C455.161336,5.08829589 455.217716,5.22261335 455.163089,5.42700949 C455.059678,6.21422662 453.132256,9.2276097 453.164974,10.7150296 C453.184254,11.6905832 453.698096,12.2780761 454.589361,12.5002839 L454.776611,12.3963338 C454.665313,12.1811339 454.649538,11.9162949 454.649538,11.6041528 C454.631719,10.6125395 455.441189,8.87488036 455.751715,8.2006651 C456.248615,7.14218509 457.134621,5.59490632 457.078242,4.74461838 C457.048153,4.32969422 456.738211,3.96090518 456.025433,3.95564928 C454.714681,3.94864141 453.40948,5.22261335 452.312561,6.92873712 L452.283349,6.92318923 C452.722701,5.93157596 453.066236,5.00887339 453.054844,4.55920188 C453.044911,4.14807365 452.81209,3.98572471 452.320449,3.98572471 C451.977205,3.99798848 451.503967,4.13055398 451.039785,4.25202368 C450.390398,4.41962852 449.710629,4.59628518 448.962213,4.75513018 C448.50066,4.81674102 448.340869,4.89966745 448.356059,5.06552032 C448.450415,7.67507503 446.672851,10.7433531 445.489465,10.7521129 C444.980296,10.7521129 444.8652,10.3812799 444.8652,9.86795361 C444.860234,8.06488766 446.342753,5.03369292 447.795477,4.55219401 C447.919044,4.51511071 448.042612,4.49029118 448.125575,4.46401168 L448.31078,3.97521291 C448.002884,4.04032768 447.272286,4.05259145 446.885516,4.06164328 L443.704014,4.06164328 C444.54591,2.06089707 445.723162,0.760645632 447.452233,0.684727066 C448.524614,0.649395734 449.2482,1.05526807 449.309838,1.66904047 C449.355117,2.19141861 449.209348,2.61656258 448.791029,3.04871441 L448.909338,3.16726417 C449.856106,2.72080461 450.508415,1.96220294 450.515426,1.44332874 C450.527987,0.640635899 449.558726,0.146581231 448.012524,0.160596967 C446.048879,0.174904696 443.627186,0.617568335 441.939012,4.12150215 C441.433057,4.19566875 440.973257,4.38780112 440.592037,4.79746938 L440.660102,4.95076649 C440.937326,4.85207235 441.265379,4.83951659 441.629071,4.83951659 C441.395373,5.41124179 440.927394,6.66068619 440.456201,7.941374 C439.033566,9.8203585 437.601875,10.7150296 436.555202,10.7150296 C435.981766,10.7343012 435.750405,10.4148593 435.747776,9.86795361 C435.739889,9.52223214 435.824604,9.0421932 435.895882,8.788158 C437.013541,8.22548463 438.140256,7.59565253 439.158886,6.55118826 C439.715671,5.94413172 440.104193,5.33911915 440.120844,4.71103901 C440.127855,4.12150215 439.76504,3.81636791 439.017499,3.80760808 C437.953298,3.79330035 436.671758,4.52387055 435.833368,5.41124179 C434.740831,6.60403926 433.892508,8.29235137 433.876734,9.79232703 L433.876734,9.79232703 Z M418.532435,5.50292806 L418.638475,5.41124179 C418.491246,5.17297429 418.437495,4.74461838 418.44363,4.49029118 C418.500009,2.36778328 420.740002,1.164474 424.244591,1.164474 L426.181653,1.164474 C425.054646,1.82262957 424.109338,2.69072918 423.384876,4.32969422 C423.07435,5.03369292 421.589785,8.82728526 420.984216,10.5296131 C420.233462,12.5586828 419.749708,13.4799254 419.153779,13.816595 L419.256314,13.9985076 C420.934263,14.1042096 421.936826,13.2469138 422.580956,11.6605077 C423.194996,10.16608 424.007972,7.77902506 424.405258,6.72054506 C425.696438,3.30654554 426.26111,1.87372861 427.291133,1.164474 C428.724576,1.15746614 430.106314,1.15746614 430.106314,1.15746614 C431.647258,1.11512694 432.304825,0.732322167 432.786826,0.134317463 L432.678157,0 C432.293432,0.208192067 431.455918,0.247027334 430.749859,0.250531268 L423.78742,0.250531268 C419.874152,0.250531268 417.473492,1.53676697 417.083509,3.45108281 C416.891001,4.37553735 417.406596,5.37795442 418.532435,5.50292806 L418.532435,5.50292806 Z M470.226366,4.81849298 C470.695222,4.59978912 471.086958,4.58723335 471.415303,4.65264012 C471.292612,4.91193122 470.72794,6.05187769 470.286544,7.07502636 C469.591001,8.68070403 468.546956,10.3003974 467.577987,10.5313651 C467.24526,10.6285992 467.047493,10.48377 467.053044,10.1520642 C467.081964,8.7300511 468.645986,5.55957499 470.226366,4.81849298 L470.226366,4.81849298 Z M456.477054,10.5526807 C456.477054,11.2619353 456.930136,11.701095 457.792188,11.6765674 C458.682576,11.6605077 459.590784,11.1314137 460.342706,10.4060994 C460.48497,11.171709 461.039126,11.7294184 462.165256,11.6905832 C463.340756,11.646492 464.462505,10.9127099 465.241887,10.058626 L465.241887,10.3039014 C465.241887,11.0943304 465.649689,11.6818233 466.549717,11.6818233 C467.520731,11.6818233 468.637806,10.9547571 469.518554,9.69713683 L469.549519,9.71261254 C469.467433,10.0110309 469.372201,10.5138454 469.358179,10.852559 C469.345034,11.7983291 469.907077,12.3452348 470.689088,12.5002839 L470.878675,12.4243653 C470.591811,11.7384703 470.99085,10.0285506 471.156775,9.4606213 C471.739267,7.58864466 472.665002,5.44832509 473.199001,4.33845405 C472.955371,4.13055398 472.383688,3.98747668 471.776366,3.96090518 C469.759555,3.88703058 467.728138,4.71804688 466.246202,7.33811339 C465.992933,7.79479277 465.71308,8.32067483 465.510055,8.87488036 C465.300311,9.15548706 465.080343,9.40426636 464.984235,9.49390867 C464.449359,10.0110309 463.688673,10.6706464 462.917179,10.6814502 C462.475198,10.6884581 462.234197,10.3812799 462.243837,9.83087031 C462.253477,7.73668586 464.103487,4.55219401 465.357275,4.54489415 C465.704316,4.54489415 465.850669,4.69497932 465.850669,4.98960175 C465.850669,5.33707519 465.614342,5.81886609 465.272851,6.12604429 L465.421834,6.25831779 C466.26373,5.93537189 467.047493,5.35138292 467.053044,4.72505475 C467.053044,4.01229621 466.230428,3.88002271 465.501291,3.88703058 C464.521806,3.90104631 463.301904,4.37933328 462.320665,5.45007705 C461.094921,6.78945575 460.459263,8.3965934 460.333066,9.5452997 C459.773652,10.1979074 459.145006,10.6443669 458.729608,10.6496228 C458.49036,10.6583827 458.321806,10.5313651 458.321806,10.2825858 C458.321806,10.0656339 458.444497,9.6191743 458.663296,9.0421932 C459.206059,7.69084273 459.989823,6.00778652 460.955286,4.00704031 C460.955286,4.00704031 459.485912,4.25202368 459.276461,4.31567848 C459.052403,4.37028145 458.882096,4.51511071 458.785111,4.71804688 C458.156757,6.05187769 457.409216,7.58864466 456.942405,8.735307 C456.657294,9.45857734 456.477054,10.1415524 456.477054,10.5526807 L456.477054,10.5526807 Z M460.980993,2.78416741 C461.426479,2.77891151 461.87664,2.36077541 461.973624,1.87022467 C462.082294,1.36215427 461.788419,0.9688377 461.337382,0.981101468 C460.895109,0.982853435 460.449623,1.39047774 460.342706,1.89854814 C460.246598,2.39435477 460.524698,2.79146727 460.980993,2.78416741 L460.980993,2.78416741 Z M429.815944,4.57146565 C430.058698,4.57146565 430.143413,4.74082245 430.143413,4.95076649 C430.143413,5.95464352 428.903355,7.23737529 427.326479,8.17263363 C427.720844,6.62155893 428.839964,4.55920188 429.815944,4.57146565 L429.815944,4.57146565 Z M431.275678,7.99977289 C430.293564,9.42704193 428.921174,10.7150296 427.741293,10.7150296 C427.239135,10.7343012 427.018291,10.4466867 427.027931,9.86795361 C427.027931,9.52223214 427.109433,9.03518534 427.177205,8.788158 C428.293696,8.22548463 429.42859,7.59565253 430.439333,6.55118826 C431.004005,5.94413172 431.379966,5.33911915 431.397493,4.71103901 C431.407426,4.12150215 431.035846,3.81636791 430.301451,3.80760808 C429.2317,3.79330035 427.950452,4.52387055 427.11732,5.41124179 C426.023615,6.60403926 425.180842,8.29235137 425.158057,9.79232703 C425.146372,10.852559 425.650575,11.6958391 427.018291,11.646492 C428.48153,11.6041528 429.921985,10.4767621 430.664267,9.6615135 C430.574293,10.0110309 430.514992,10.3392327 430.514992,10.6093276 C430.514992,11.5530538 430.983556,12.2217211 431.91046,12.5058318 L432.094789,12.4194014 C432.011826,12.1636142 431.990793,11.8990672 432.011826,11.5988969 C432.077262,10.6814502 432.439785,9.64924974 432.978458,8.28709547 C433.999425,5.71287209 435.485743,2.76839971 436.140388,1.03395247 L434.58104,1.3285749 C434.338287,1.37996593 434.183754,1.5668424 434.103713,1.74145511 C433.350622,3.34012491 432.577667,5.04420472 431.612203,7.26569876 C431.501781,7.5019223 431.397493,7.75245356 431.275678,7.99977289 L431.275678,7.99977289 Z M412,17.5535404 C412,17.7915159 428.560403,18 444.860234,18 C461.161817,18 477.720467,17.7915159 477.720467,17.5535404 C477.720467,17.313229 461.161817,17.1161327 444.860234,17.1161327 C428.560403,17.1161327 412,17.313229 412,17.5535404 L412,17.5535404 Z"
                        id="telefonica-data-unit-logo"></path>
                    </g>
                  </g>
                </g>
              </svg>
            </a>
          </div>
        </footer>
      </div>
    </div>
  </div>
  <script src="../js/site-fecf6251d9fcedbadc1b-b9f40ab5.js"></script>
</body>

</html>

<?php
if ($pwd_show_policy_pos === 'below') {
    show_policy($messages, $pwd_policy_config, $result);
}
?>

<?php } else {

    # Notify password change
    if ($mail and $notify_on_change) {
        $data = array( "login" => $login, "mail" => $mail, "password" => $newpassword);
        if ( !send_mail($mailer, $mail, $mail_from, $mail_from_name, $messages["changesubject"], $messages["changemessage"].$mail_signature, $data) ) {
            error_log("Error while sending change email to $mail (user $login)");
        }
    }

    if (isset($messages['passwordchangedextramessage'])) {
        include("password-changed.php");
    }

}
?>
